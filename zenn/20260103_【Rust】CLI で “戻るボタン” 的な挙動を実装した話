# 【初めてのRust / Codex】CLI で “戻るボタン” 的な挙動を実装した話

先日、CLI 上でディレクトリ移動を「戻る」ことができるツールを作り、
その使い方や挙動についての記事を投稿しました。
この記事はその実装の振り返りです。

 **使い方・挙動についての記事はこちら**

@[card](https://zenn.dev/01mu/articles/c2cf2666067f56)

## 使用技術について

このツールで使っている技術自体は、シンプルだと思います。

- Rust
- SQLite
- rusqlite
- シェル（bash / zsh 側のラッパー）

いままでCLIツールはShellScriptやPowerShellのみで書いており、
Rust は今回が初めてでしたが、AI（Codex / ChatGPT）のお陰もあり、スムーズに開発を進めることができました。

また、実際に作り始めるとrusqlite を使った SQLite 操作がメインで、
シンプルなCRUD処理にフォーカスして考えればよく、そこまで大きな技術的な壁には直面せず進めることができました。

## SQLite と RDB 的な考え方での設計

状態管理には SQLite を使いました。

- 状態をテーブルとして切る
- レコードがどのタイミングで増減するか、データフローを考える
- 不要になったものを一定サイクルで消す

など...
普段 PostgreSQL などで設計をしている私のRDB脳にハマりました。
SQLiteを学習用途以外で用いたのは初めてだったのですが、ローカルに置けるRDBとしてとても使い勝手がよいなと感じました。

## テーブル構成とデータフロー


### events テーブル（移動イベントの履歴）

`events` は、ディレクトリ移動の履歴そのものです。
`cd` が発生するたびに 1 レコード追加されます。

| カラム名 | 内容 |
|---|---|
| id | イベントID |
| session_key | どのセッションのイベントか |
| path | 移動先のディレクトリ |
| ts | 記録時刻 |

**ライフサイクル**

- 生成：`cd` によるディレクトリ移動時に追加
- 使用：「戻る」先の計算や、undo の参照元として使う
- 破棄：一定条件で古いものを間引く

### sessions テーブル（セッション状態）

`sessions` は、シェル起動ごとの状態を持つテーブルです。
「履歴」は `events` に積み、**セッションの“現在位置や直近操作”はここに寄せる**、という分け方になっています。

| カラム名 | 内容 |
|---|---|
| session_key | セッションID |
| cursor_id | 現在指している `events.id`。カーソル |
| last_bd_delta | 直近の `bd` の移動量（何段戻ったか） |
| last_bd_from_id | 直近 `bd` の移動元 `events.id` |
| last_bd_to_id | 直近 `bd` の移動先 `events.id` |
| last_bd_armed | 直近 `bd` がキャンセル可能な状態かどうか（true/false）|
| last_seen_at | 最終アクセス時刻 |

**ライフサイクル**

- 生成：その `session_key` が初めて使われたタイミングで作る
- 使用：カーソル更新、直近 `bd` 情報の保持、cleanup の判断材料
- 破棄：一定期間見ていないセッションを cleanup 対象にする

### undo_moves テーブル（キャンセル用の一時データ）

`undo_moves` は、「戻る」をキャンセルするための情報を一時的に持つテーブルです。
`from_id / to_id` は `events.id` を参照します。

| カラム名 | 内容 |
|---|---|
| id | undoレコードID |
| session_key | 対象セッション |
| from_id | 戻る前の `events.id` |
| to_id | 戻った先の `events.id` |
| created_at | 作成時刻 |

**ライフサイクル**

- 生成：「戻る」を実行した直後に追加
- 使用：「キャンセル」操作のときに参照
- 破棄：キャンセルが完了したら削除（短命データ）

## データのクリーンアップサイクルについて

次のルールで古いデータを削除しています。

### cleanup 実行タイミング：
前回のcleanupから**10日**以上経ったタイミングで実行。
「毎週月曜の朝に一瞬重たくなるタイミングがあるな...？」と勘づかれないように、ユーザーが規則性を掴みにくくなるようなタイミングを意識しました。（もっとも、実際に気づかれることはほとんどないと思います）

### sessions の保持期間：
最終アクセス（`last_seen_at`）から **180日** を超えたセッションを削除 。
ただし「今実行中のセッション」は削除対象から除外。

### undo_moves の保持期間：
作成時刻（`created_at`）から **90日** を超えたレコードを削除。

### events の保持：
cleanup では削除しない。
別処理で **1セッションあたり概ね 10,000 件**を上限として古い履歴を間引く。

## AI（Codex / ChatGPT）をどう使っていたか

今回の開発では、
Codex と ChatGPT を積極的に使用しました。
※ちなみに、私はChatGPT Plusユーザーです。

1. ChatGPTと仕様の相談
2. ChatGPTにCodex用のプロンプトを組んでもらう
3. Codex にコードを書いてもらう
4. 自分で読んで理解する / 動かして挙動を把握する
5. 分からないところを ChatGPT に聞く

という流れをひたすら繰り返しました。
おかげで、Rust初学でもつくりきることができました。

## おわりに

ChatGPT と Codex のおかげで設計にフォーカスして取り組むことができました。
いちプログラマとして、コーディングの全般をAIに任せることへの葛藤もあったのですが（実務でのAIコーディングだとむしろ気にならないのですが、プライドですかね...?）、プライベートの限られた時間で Codex を用いた開発はスピーディーで体験が良かったです。

最近のXでよく目にする**理解負債**を残さないように理解に努めながら臨みましたが、その理解の補助にもChatGPTを手放せず、仮にハルシネーションが起こっても自覚することは難しいですね。
これについては時間をかけて学習することで自分の技術を磨くか、人とのコミュニケーションを通して正解を探っていくしかないのだろうなと思います。

今回に関しては、なによりも自作CLIツールが手元で動いている喜びが大きかったです。
この感覚を大事にしながら、今後もこういったツール開発には継続的に取り組んでいきたいです。

@[card](https://github.com/01-mu/back-directory)
