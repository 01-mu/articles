# 【Rust】CLI で “戻るボタン” 的な挙動を実装した話

先日、CLI 上でディレクトリ移動を「戻る」ことができるツールを作り、
その使い方や挙動についての記事を投稿しました。

 **使い方・挙動についての記事はこちら**
https://zenn.dev/01mu/articles/c2cf2666067f56

この記事はその実装の振り返りです

- どんな技術を使ったか
- テーブル設計やデータの流れをどう考えたか
- AI（Codex / ChatGPT）をどう使っていたか

という 3 点でまとめました。

## 使用技術について

このツールで使っている技術自体は、シンプルだと思います。

- Rust
- SQLite
- rusqlite
- シェル（bash / zsh 側のラッパー）

いままでCLIツールはShellScriptやPowerShellのみで書いており、
Rust は今回が初めてでしたが、AI（Codex / ChatGPT）のお陰もあり、スムーズに開発を進めることができました。

また、実際に作り始めるとrusqlite を使った SQLite 操作がメインで、
シンプルなCRUD処理にフォーカスして考えればよく、そこまで技術的な壁には直面せず進めることができました。

## SQLite と RDB 的な考え方での設計

状態管理には SQLite を使いました。

- 状態をテーブルとして切る
- レコードがどのタイミングで増減するか、データフローを考える
- 不要になったものを一定サイクルで消す

など...
普段 PostgreSQL などで設計をしている私のRDB脳にハマりました。
SQLiteを学習用途以外で用いたのは初めてだったのですが、ローカルに置けるRDBとしてとても使い勝手がよいなと感じました。

## テーブル構成とデータフロー


### events テーブル（移動イベントの履歴）

`events` は、ディレクトリ移動の履歴そのものです。
`cd` が発生するたびに 1 レコード追加されます。

| カラム名 | 内容 |
|---|---|
| id | イベントID |
| session_key | どのセッションのイベントか |
| path | 移動先のディレクトリ |
| ts | 記録時刻 |

**ライフサイクル**

- 生成：`cd` によるディレクトリ移動時に追加
- 使用：「戻る」先の計算や、undo の参照元として使う
- 破棄：一定条件で古いものを間引く

### sessions テーブル（セッション状態）

`sessions` は、シェル起動ごとの状態を持つテーブルです。
「履歴」は `events` に積み、**セッションの“現在位置や直近操作”はここに寄せる**、という分け方になっています。

| カラム名 | 内容 |
|---|---|
| session_key | セッションID |
| cursor_id | 現在指している `events.id`。カーソル |
| last_bd_delta | 直近の `bd` の移動量（何段戻ったか） |
| last_bd_from_id | 直近 `bd` の移動元 `events.id` |
| last_bd_to_id | 直近 `bd` の移動先 `events.id` |
| last_bd_armed | 直近 `bd` のキャンセル可能状態フラグ(true/false) |
| last_seen_at | 最終アクセス時刻 |

**ライフサイクル**

- 生成：その `session_key` が初めて使われたタイミングで作る
- 使用：カーソル更新、直近 `bd` 情報の保持、cleanup の判断材料
- 破棄：一定期間見ていないセッションを cleanup 対象にする

### undo_moves テーブル（キャンセル用の一時データ）

`undo_moves` は、「戻る」をキャンセルするための情報を一時的に持つテーブルです。
`from_id / to_id` は `events.id` を参照します。

| カラム名 | 内容 |
|---|---|
| id | undoレコードID |
| session_key | 対象セッション |
| from_id | 戻る前の `events.id` |
| to_id | 戻った先の `events.id` |
| created_at | 作成時刻 |

**ライフサイクル**

- 生成：「戻る」を実行した直後に追加
- 使用：「キャンセル」操作のときに参照
- 破棄：キャンセルが完了したら削除（短命データ）

## データのライフサイクル設計と cleanup の考え方

ライフサイクルや cleanup の方針について

- どのくらい残すのが適切か
- いつ消すべきか。削除の頻度が多いと体験を損ないそう

私の中に明確な答えがなく、かなり迷いましたが
ChatGPT に壁打ちしながら自分の感覚値ベースで考えました。

## AI（Codex / ChatGPT）をどう使っていたか

今回の開発では、
Codex と ChatGPT を積極的に使用しました。
※ちなみに、私はChatGPT Plusユーザーです。

1. ChatGPTと仕様の相談
2. ChatGPTにCodex用のプロンプトを組んでもらう
3. Codex にコードを書いてもらう
4. 自分で読んで理解する / 動かして挙動を把握する
5. 分からないところを ChatGPT に聞く

という流れをひたすら繰り返しました。
おかげで、Rust初学でもつくりきることができました。

## おわりに

Rust の勉強というよりは、
状態を持つ CLI ツールをどう作るか
を考える良い題材だったと思います。

Codex と ChatGPT がなければ、
ここまでスムーズには進まなかったので、
その点でも良い経験でした。

なにより、自作CLIツールが手元で動いている喜びが大きいです。
今後どんどんこういったツール開発を進めていきたいと思います。
@[card](https://github.com/01-mu/back-directory)
